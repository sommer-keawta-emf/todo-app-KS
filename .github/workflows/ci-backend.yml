name: Build and save my Docker image to a registry

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'

env:
  REGISTRY: "acrfi21210.azurecr.io"
  IMAGE_NAME: "todo-backend-kso"

jobs:
  # Job de test pour v√©rifier la construction de l'image
  test-docker:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build Docker image locally (test)
        run: |
          echo "Simulating Docker build..."
          docker build -t test-image:latest ./backend

      - name: Verify Docker image exists
        run: |
          echo "Listing local Docker images..."
          docker images | grep test-image

  # Job principal : build + push sur ACR
  build-and-deploy:
    runs-on: ubuntu-latest
    needs: test-docker  # S'assure que le test passe avant de builder/pusher
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Log in to ACR
        uses: azure/docker-login@v1
        with:
          login-server: ${{ env.REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build Docker image
        run: |
          docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} ./backend

      - name: Push Docker image
        run: |
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}